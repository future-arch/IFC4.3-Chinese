name: Deploy to Tencent Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Static Site
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 43.161.249.104 >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          echo "ğŸš€ Starting deployment..."

          # åŒæ­¥æ‰€æœ‰é™æ€æ–‡ä»¶åˆ°æœåŠ¡å™¨
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='README.md' \
            --exclude='.gitignore' \
            ./ \
            deployer@43.161.249.104:/home/deployer/IFC4.3-Chinese/

          echo "âœ… Files synced to server"

      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."

          ssh deployer@43.161.249.104 << 'ENDSSH'
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ -f ~/IFC4.3-Chinese/index.html ]; then
              echo "âœ… index.html found"
            else
              echo "âŒ index.html not found"
              exit 1
            fi

            # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            echo "ğŸ“‚ Deployed files:"
            ls -lh ~/IFC4.3-Chinese/ | head -10
          ENDSSH

          # æµ‹è¯•ç½‘ç«™è®¿é—®
          echo "ğŸŒ Testing website..."
          if curl -f -s -I https://ifc4-3-chinese.19650.org 2>&1 | head -1 | grep -E "200|301|302"; then
            echo "âœ… Website is accessible"
          else
            echo "âš ï¸  Website may not be fully accessible yet"
          fi

          echo "âœ¨ Deployment completed!"

      - name: Deployment notification
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Deployment succeeded!"
            echo "ğŸŒ Visit: https://ifc4-3-chinese.19650.org"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
